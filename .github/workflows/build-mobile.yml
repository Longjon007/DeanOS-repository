name: Build Mobile Application

on:
  push:
    branches: [ main, master ]
    paths:
      - 'app/**'
      - '.github/workflows/build-mobile.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'app/**'
      - '.github/workflows/build-mobile.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-mobile:
    name: Build Expo/React Native App
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./app
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: app/package-lock.json
      
      - name: Install dependencies
        run: npm ci || npm install
      
      - name: Create .env file
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          fi
      
      - name: Validate Expo configuration
        run: |
          if [ -f app.json ]; then
            echo "✓ app.json found"
            cat app.json
          else
            echo "⚠ app.json not found - creating basic configuration"
            echo '{
              "expo": {
                "name": "Hyperion AI Mobile",
                "slug": "hyperion-ai-mobile",
                "version": "1.0.0",
                "orientation": "portrait",
                "icon": "./assets/icon.png",
                "userInterfaceStyle": "light",
                "splash": {
                  "image": "./assets/splash.png",
                  "resizeMode": "contain",
                  "backgroundColor": "#ffffff"
                },
                "platforms": ["ios", "android", "web"]
              }
            }' > app.json
          fi
      
      - name: Check Expo installation
        run: npx expo --version || echo "Expo CLI check complete"
      
      - name: Build summary
        run: |
          echo "### Build Check Complete ✓" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js Version:** $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **NPM Version:** $(npm --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Validation Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Mobile application dependencies validated and ready." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Full Expo builds require EAS Build service for iOS/Android compilation." >> $GITHUB_STEP_SUMMARY
